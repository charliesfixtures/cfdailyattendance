<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CF Daily Attendance</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       transparent;
      --row-bg:   #1e2130;
      --row-hover:#252839;
      --border:   #2d3148;
      --text:     #dde1f0;
      --sub:      #7880a0;
      --present:  #7880a0;
      --late:     #e6a817;
      --absent:   #e54545;
      --sick:     #9b59f5;
      --vacation: #11c987;
      --radius:   8px;
    }

    html {
      overflow: hidden; /* Let Trello handle scrolling, not us */
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 0;
      margin: 0;
      overflow: visible;
    }

    /* â”€â”€ Auth screen â”€â”€ */
    .auth-screen {
      padding: 16px;
      background: #1e2130;
      border-radius: var(--radius);
      margin: 8px;
    }
    .auth-screen p {
      font-size: 12px; color: var(--sub);
      line-height: 1.7; margin-bottom: 12px;
    }
    .auth-screen a { color: #5b8dee; }
    .auth-textarea {
      width: 100%; padding: 8px; border-radius: 6px;
      border: 1px solid var(--border); background: #0d0f14;
      color: var(--text); font-family: monospace; font-size: 11px;
      resize: none; height: 60px; margin-bottom: 8px;
    }
    .auth-textarea:focus { outline: none; border-color: #5b8dee; }

    /* â”€â”€ Loading / error â”€â”€ */
    .state {
      padding: 20px 16px; text-align: center;
      font-size: 12px; color: var(--sub); font-family: monospace;
    }
    .state.error { color: var(--absent); }
    .spinner {
      width: 20px; height: 20px; border: 2px solid var(--border);
      border-top-color: #5b8dee; border-radius: 50%;
      animation: spin .7s linear infinite; margin: 0 auto 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Header â”€â”€ */
    .hdr {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 12px 8px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 4px;
    }
    .hdr-left { display: flex; align-items: center; gap: 8px; }
    .hdr-title { font-size: 12px; font-weight: 600; color: var(--sub); letter-spacing: 0.6px; text-transform: uppercase; }
    .hdr-date  { font-size: 11px; color: var(--sub); opacity: 0.6; }
    .hdr-right { display: flex; gap: 6px; align-items: center; }
    .btn-sm {
      padding: 4px 10px; border-radius: 5px; font-size: 11px;
      font-family: 'Inter', sans-serif; font-weight: 500;
      cursor: pointer; border: 1px solid var(--border);
      background: transparent; color: var(--sub); transition: all 0.15s;
    }
    .btn-sm:hover { border-color: var(--sub); color: var(--text); }
    .btn-sm.primary {
      background: #5b8dee; border-color: #5b8dee; color: #fff;
    }
    .btn-sm.primary:hover { opacity: 0.88; }
    .btn-sm:disabled { opacity: 0.35; cursor: not-allowed; }

    /* â”€â”€ Employee list â”€â”€ */
    .emp-list { padding: 0 8px; }

    /* â”€â”€ Single employee row â”€â”€ */
    .emp-row {
      display: flex; align-items: center; gap: 10px;
      padding: 7px 8px; border-radius: var(--radius);
      margin-bottom: 3px; transition: background 0.15s;
      position: relative;
    }
    .emp-row:hover { background: var(--row-hover); }

    /* Left accent bar â€” shows status color */
    .emp-row::before {
      content: ''; position: absolute; left: 0; top: 6px; bottom: 6px;
      width: 3px; border-radius: 2px; background: transparent;
      transition: background 0.2s;
    }
    .emp-row.s-L::before { background: var(--late); }
    .emp-row.s-A::before { background: var(--absent); }
    .emp-row.s-S::before { background: var(--sick); }
    .emp-row.s-V::before { background: var(--vacation); }

    /* Avatar */
    .emp-avatar {
      width: 28px; height: 28px; border-radius: 50%;
      background: var(--border); flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 600; color: var(--sub);
      overflow: hidden; border: 1.5px solid var(--border);
      transition: border-color 0.2s;
    }
    .emp-avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .emp-row.s-L .emp-avatar { border-color: var(--late); }
    .emp-row.s-A .emp-avatar { border-color: var(--absent); }
    .emp-row.s-S .emp-avatar { border-color: var(--sick); }
    .emp-row.s-V .emp-avatar { border-color: var(--vacation); }

    /* Name */
    .emp-name {
      font-size: 13px; font-weight: 500; color: var(--text);
      flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      min-width: 0;
    }

    /* LASV counters â€” only non-zero shown */
    .emp-counters {
      display: flex; gap: 6px; align-items: center;
      flex-shrink: 0; font-size: 11px; color: var(--sub);
      white-space: nowrap;
    }
    .ctr { display: flex; align-items: center; gap: 2px; }
    .ctr-val { font-weight: 600; }
    .ctr-L .ctr-val { color: var(--late); }
    .ctr-A .ctr-val { color: var(--absent); }
    .ctr-S .ctr-val { color: var(--sick); }
    .ctr-V .ctr-val { color: var(--vacation); }

    /* Dropdown */
    .emp-dropdown {
      flex-shrink: 0;
      position: relative;
    }
    .status-select {
      appearance: none; -webkit-appearance: none;
      padding: 4px 22px 4px 9px;
      border-radius: 20px; border: 1px solid var(--border);
      background: #0d0f14 url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%237880a0' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E") no-repeat right 7px center;
      color: var(--present);
      font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 500;
      cursor: pointer; transition: all 0.15s; min-width: 82px;
    }
    .status-select:focus { outline: none; border-color: #5b8dee; }

    /* Color the select based on value */
    .status-select.v-P { color: var(--present); border-color: var(--border); }
    .status-select.v-L { color: var(--late);    border-color: var(--late);    background-color: #1e1a08; }
    .status-select.v-A { color: var(--absent);  border-color: var(--absent);  background-color: #1e0808; }
    .status-select.v-S { color: var(--sick);    border-color: var(--sick);    background-color: #13081e; }
    .status-select.v-V { color: var(--vacation);border-color: var(--vacation);background-color: #081e12; }

    /* â”€â”€ Footer â”€â”€ */
    .footer {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 12px 12px; margin-top: 6px;
      border-top: 1px solid var(--border);
    }
    .footer-counts {
      display: flex; gap: 10px; font-size: 11px;
    }
    .fc { display: flex; align-items: center; gap: 3px; font-weight: 500; }
    .fc-dot { width: 6px; height: 6px; border-radius: 50%; }

    .footer-actions { display: flex; gap: 6px; }

    /* â”€â”€ Submit progress â”€â”€ */
    .submit-progress {
      padding: 20px 16px; text-align: center;
    }
    .progress-bar-wrap {
      height: 4px; background: var(--border); border-radius: 2px;
      margin: 10px 0 8px; overflow: hidden;
    }
    .progress-bar {
      height: 100%; background: #5b8dee; border-radius: 2px;
      transition: width 0.4s ease; width: 0%;
    }
    .progress-label {
      font-size: 11px; color: var(--sub); font-family: monospace;
      min-height: 16px;
    }

    /* â”€â”€ Summary card shown after submit â”€â”€ */
    .summary-card {
      margin: 8px 12px 12px;
      background: #1a1f35; border: 1px solid #2d3148;
      border-radius: var(--radius); overflow: hidden;
    }
    .summary-header {
      background: #1e2540; padding: 10px 14px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .summary-header-title {
      font-size: 12px; font-weight: 600; color: var(--text);
    }
    .summary-header-sub {
      font-size: 10px; color: var(--sub);
    }
    .summary-section {
      padding: 8px 14px; border-top: 1px solid #2d3148;
    }
    .summary-section-label {
      font-size: 10px; font-weight: 600; letter-spacing: 0.5px;
      text-transform: uppercase; margin-bottom: 5px;
      display: flex; align-items: center; gap: 5px;
    }
    .summary-names {
      font-size: 12px; color: var(--text); line-height: 1.8;
    }
    .summary-name-pill {
      display: inline-block; margin: 1px 3px 1px 0;
      padding: 1px 8px; border-radius: 20px; font-size: 11px;
    }
    .summary-footer {
      padding: 8px 14px; border-top: 1px solid #2d3148;
      display: flex; justify-content: space-between; align-items: center;
    }
    .summary-footer-stat {
      font-size: 11px; color: var(--sub);
    }
    .btn-reopen {
      font-size: 11px; color: var(--sub); background: transparent;
      border: 1px solid var(--border); border-radius: 5px;
      padding: 3px 10px; cursor: pointer; font-family: 'Inter', sans-serif;
      transition: all 0.15s;
    }
    .btn-reopen:hover { border-color: var(--sub); color: var(--text); }

    /* â”€â”€ Edit mode â”€â”€ */
    .edit-section {
      margin: 0 12px 12px;
      background: #1a1f35; border: 1px solid #2d3148;
      border-radius: var(--radius); overflow: hidden;
    }
    .edit-header {
      background: #1e2540; padding: 8px 14px;
      font-size: 11px; font-weight: 600; color: var(--sub);
      letter-spacing: 0.5px; text-transform: uppercase;
      display: flex; justify-content: space-between; align-items: center;
    }
    .edit-row {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 14px; border-top: 1px solid #2d3148;
      flex-wrap: wrap;
    }
    .edit-name { font-size: 12px; font-weight: 500; flex: 1; min-width: 100px; }
    .edit-counters { display: flex; gap: 6px; flex-wrap: wrap; }
    .edit-field {
      display: flex; align-items: center; gap: 4px;
    }
    .edit-field label { font-size: 10px; color: var(--sub); }
    .edit-input {
      width: 40px; padding: 3px 6px; border-radius: 5px;
      border: 1px solid var(--border); background: #0d0f14;
      color: var(--text); font-size: 12px; text-align: center;
      font-family: 'Inter', sans-serif;
    }
    .edit-input:focus { outline: none; border-color: #5b8dee; }
    .btn-save-edit {
      font-size: 11px; padding: 3px 10px; border-radius: 5px;
      border: 1px solid #5b8dee; background: transparent;
      color: #5b8dee; cursor: pointer; font-family: 'Inter', sans-serif;
      transition: all 0.15s; white-space: nowrap;
    }
    .btn-save-edit:hover { background: #5b8dee; color: #fff; }
    .btn-save-edit:disabled { opacity: 0.4; cursor: not-allowed; }

    /* â”€â”€ Status message â”€â”€ */
    .status-msg {
      text-align: center; font-size: 11px; font-family: monospace;
      padding: 4px 12px 10px; min-height: 20px; color: var(--vacation);
    }
    .status-msg.error { color: var(--absent); }

    /* â”€â”€ Divider between employees â”€â”€ */
    .emp-divider {
      height: 1px; background: var(--border); opacity: 0.4;
      margin: 0 8px 3px;
    }
  </style>
</head>
<body>
<div id="app"><div class="state"><div class="spinner"></div>Loading...</div></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CFG = {
  API_KEY:        '53abc1f4686798eadbeb8f91ea79c9bb',
  LOG_BOARD_ID:   '6965633f4fe5254c47e38527',
  SLACK_WEBHOOK:  'SLACK_WEBHOOK_PLACEHOLDER',
  EMP_LIST_NAME:  '2026 Employee',
  LOG_LIST_NAME:  '', // set to current year automatically
};

const STATUS = {
  P: { label: 'Present',  emoji: '',   color: 'var(--present)' },
  L: { label: 'Late',     emoji: 'ğŸ•', color: 'var(--late)'    },
  A: { label: 'Absent',   emoji: 'âŒ', color: 'var(--absent)'  },
  S: { label: 'Sick',     emoji: 'ğŸ¤’', color: 'var(--sick)'    },
  V: { label: 'Vacation', emoji: 'ğŸŒ´', color: 'var(--vacation)'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let t            = null;
let token        = null;
let employees    = [];    // [{ name, photo, counters:{L,A,S,V}, cardId }]
let selections   = {};    // { name: 'P'|'L'|'A'|'S'|'V' }  default P
let submitted    = false;

function today() {
  return new Date().toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
}
function year() { return new Date().getFullYear().toString(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Trello API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(path, method='GET', body=null) {
  const sep = path.includes('?') ? '&' : '?';
  const url = `https://api.trello.com/1${path}${sep}key=${CFG.API_KEY}&token=${token}`;
  const opts = { method, headers:{'Content-Type':'application/json'} };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(url, opts);
  if (!res.ok) throw new Error(`Trello ${res.status}: ${await res.text()}`);
  return res.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Load employees from "2026 Employee" list
//  Also pre-loads their LASV counters from the log list
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadEmployees() {
  setState('loading', 'Fetching employee list...');

  // Get all lists on hidden board
  const lists = await api(`/boards/${CFG.LOG_BOARD_ID}/lists`);

  // Find employee roster list
  const empList = lists.find(l =>
    l.name.trim().toLowerCase() === CFG.EMP_LIST_NAME.toLowerCase()
  );
  if (!empList) throw new Error(
    `List "${CFG.EMP_LIST_NAME}" not found on your hidden board.`
  );

  // Fetch employee cards â€” cover for photo, desc for LASV counters, id for logging
  const cards = await api(`/lists/${empList.id}/cards?fields=name,cover,desc`);
  if (!cards.length) throw new Error(
    `No employee cards found in "${CFG.EMP_LIST_NAME}".`
  );

  employees = cards
    .map(c => {
      const name = c.name.trim();
      const photo = c.cover?.scaled
        ? (c.cover.scaled.find(s => s.width >= 70)?.url || c.cover.scaled[0]?.url || null)
        : null;
      // Read LASV counters directly from the employee card description
      const counters = parseDesc(c.desc);
      return { name, photo, counters, cardId: c.id };
    })
    .filter(e => e.name)
    .sort((a,b) => a.name.localeCompare(b.name));

  // Default everyone to Present
  selections = {};
  employees.forEach(e => selections[e.name] = 'P');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Render
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  const DATE = today();

  // Count summary
  const counts = {P:0,L:0,A:0,S:0,V:0};
  employees.forEach(e => counts[selections[e.name]]++);

  const rows = employees.map((emp, i) => {
    const sel      = selections[emp.name];
    const initials = emp.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
    const avatarInner = emp.photo
      ? `<img src="${emp.photo}" alt="" onerror="this.style.display='none';this.insertAdjacentText('afterend','${initials}')">`
      : initials;

    // Build counters â€” only show non-zero
    const { L,A,S,V } = emp.counters;
    const ctrParts = [
      L ? `<span class="ctr ctr-L"><span class="ctr-val">${L}</span>ğŸ•</span>` : '',
      A ? `<span class="ctr ctr-A"><span class="ctr-val">${A}</span>âŒ</span>` : '',
      S ? `<span class="ctr ctr-S"><span class="ctr-val">${S}</span>ğŸ¤’</span>` : '',
      V ? `<span class="ctr ctr-V"><span class="ctr-val">${V}</span>ğŸŒ´</span>` : '',
    ].filter(Boolean).join('');

    const divider = i < employees.length-1 ? '<div class="emp-divider"></div>' : '';

    return `
      <div class="emp-row${sel !== 'P' ? ' s-'+sel : ''}" id="row-${i}">
        <div class="emp-avatar">${avatarInner}</div>
        <div class="emp-name">${emp.name}</div>
        ${ctrParts ? `<div class="emp-counters">${ctrParts}</div>` : ''}
        <div class="emp-dropdown">
          <select class="status-select v-${sel}"
            onchange="setStatus(${JSON.stringify(emp.name)}, this.value, this)"
            ${submitted ? 'disabled' : ''}>
            <option value="P"${sel==='P'?' selected':''}>Present</option>
            <option value="L"${sel==='L'?' selected':''}>Late</option>
            <option value="A"${sel==='A'?' selected':''}>Absent</option>
            <option value="S"${sel==='S'?' selected':''}>Sick</option>
            <option value="V"${sel==='V'?' selected':''}>Vacation</option>
          </select>
        </div>
      </div>
      ${divider}`;
  }).join('');

  document.getElementById('app').innerHTML = `
    <div class="hdr">
      <div class="hdr-left">
        <span class="hdr-title">Attendance</span>
        <span class="hdr-date">${DATE}</span>
      </div>
      <div class="hdr-right">
        <button class="btn-sm" onclick="refreshAll()" title="Reload employees">â†º</button>
        ${!submitted
          ? `<button class="btn-sm" onclick="resetAll()">Reset</button>
             <button class="btn-sm primary" onclick="submitAttendance()" id="submitBtn">Submit</button>`
          : `<span style="font-size:11px;color:var(--vacation)">âœ“ Submitted</span>`
        }
      </div>
    </div>

    <div class="emp-list">${rows}</div>

    <div class="footer">
      <div class="footer-counts">
        <span class="fc"><span class="fc-dot" style="background:#5b8dee"></span>${counts.P}</span>
        ${counts.L ? `<span class="fc" style="color:var(--late)">ğŸ• ${counts.L}</span>` : ''}
        ${counts.A ? `<span class="fc" style="color:var(--absent)">âŒ ${counts.A}</span>` : ''}
        ${counts.S ? `<span class="fc" style="color:var(--sick)">ğŸ¤’ ${counts.S}</span>` : ''}
        ${counts.V ? `<span class="fc" style="color:var(--vacation)">ğŸŒ´ ${counts.V}</span>` : ''}
      </div>
      <span style="font-size:10px;color:var(--sub)">${employees.length} employees</span>
    </div>
    <div class="status-msg" id="statusMsg"></div>
  `;

  // Expand iframe to full content height â€” eliminates inner scrollbar
  if (t) {
    requestAnimationFrame(() => {
      t.sizeTo('#app').catch(()=>{});
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Interactions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(name, val, selectEl) {
  selections[name] = val;
  // Update select color class
  selectEl.className = `status-select v-${val}`;
  // Update row accent
  const rows = document.querySelectorAll('.emp-row');
  rows.forEach(row => {
    const nameEl = row.querySelector('.emp-name');
    if (nameEl && nameEl.textContent === name) {
      row.className = `emp-row${val !== 'P' ? ' s-'+val : ''}`;
    }
  });
  // Update footer counts
  updateFooterCounts();
  if (t) t.sizeTo('#app').catch(()=>{});
}

function updateFooterCounts() {
  const counts = {P:0,L:0,A:0,S:0,V:0};
  employees.forEach(e => counts[selections[e.name]]++);
  const fc = document.querySelector('.footer-counts');
  if (!fc) return;
  fc.innerHTML = `
    <span class="fc"><span class="fc-dot" style="background:#5b8dee"></span>${counts.P}</span>
    ${counts.L ? `<span class="fc" style="color:var(--late)">ğŸ• ${counts.L}</span>` : ''}
    ${counts.A ? `<span class="fc" style="color:var(--absent)">âŒ ${counts.A}</span>` : ''}
    ${counts.S ? `<span class="fc" style="color:var(--sick)">ğŸ¤’ ${counts.S}</span>` : ''}
    ${counts.V ? `<span class="fc" style="color:var(--vacation)">ğŸŒ´ ${counts.V}</span>` : ''}
  `;
}

function resetAll() {
  employees.forEach(e => selections[e.name] = 'P');
  render();
}

async function refreshAll() {
  try {
    await loadEmployees();
    submitted = false;
    render();
  } catch(e) { setState('error', e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Submit
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastSubmitSelections = {}; // store for summary display

async function submitAttendance() {
  const btn = document.getElementById('submitBtn');
  if (btn) btn.disabled = true;

  // Show animated progress UI
  const flagged = employees.filter(e => selections[e.name] !== 'P');
  const total   = flagged.length + 1; // +1 for Slack step
  let   step    = 0;

  function setProgress(label) {
    step++;
    const pct = Math.round((step / total) * 100);
    const bar = document.getElementById('progressBar');
    const lbl = document.getElementById('progressLabel');
    if (bar) bar.style.width = pct + '%';
    if (lbl) lbl.textContent = label;
    if (t) t.sizeTo('#app').catch(()=>{});
  }

  document.getElementById('app').innerHTML = `
    <div class="hdr">
      <div class="hdr-left">
        <span class="hdr-title">Attendance</span>
        <span class="hdr-date">${today()}</span>
      </div>
    </div>
    <div class="submit-progress">
      <div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:4px">
        Submitting attendance...
      </div>
      <div style="font-size:11px;color:var(--sub);margin-bottom:10px">
        ${flagged.length > 0 ? `Logging ${flagged.length} employee${flagged.length>1?'s':''} + Slack` : 'Sending Slack summary...'}
      </div>
      <div class="progress-bar-wrap">
        <div class="progress-bar" id="progressBar" style="width:5%"></div>
      </div>
      <div class="progress-label" id="progressLabel">Starting...</div>
    </div>`;
  if (t) t.sizeTo('#app').catch(()=>{});

  try {
    for (const emp of flagged) {
      setProgress(`Logging ${emp.name}...`);
      await logEmployee(emp, selections[emp.name]);
    }

    setProgress('Notifying Slack...');
    await sendSlack();

    // Save selections for summary
    lastSubmitSelections = { ...selections };
    submitted = true;
    showSummary();

  } catch(e) {
    console.error(e);
    document.getElementById('app').innerHTML = `
      <div class="hdr">
        <div class="hdr-left"><span class="hdr-title">Attendance</span></div>
        <div class="hdr-right">
          <button class="btn-sm" onclick="render()">â†º Back</button>
        </div>
      </div>
      <div class="state error">âš ï¸ ${e.message}<br/><br/>
        <button class="btn-sm" onclick="submitted=false;render()">â†º Try Again</button>
      </div>`;
    if (t) t.sizeTo('#app').catch(()=>{});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Summary screen (shown after submit)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showSummary() {
  const DATE     = today();
  const sel      = lastSubmitSelections;
  const present  = employees.filter(e => sel[e.name]==='P').map(e=>e.name);
  const late     = employees.filter(e => sel[e.name]==='L').map(e=>e.name);
  const absent   = employees.filter(e => sel[e.name]==='A').map(e=>e.name);
  const sick     = employees.filter(e => sel[e.name]==='S').map(e=>e.name);
  const vacation = employees.filter(e => sel[e.name]==='V').map(e=>e.name);

  const section = (emoji, label, color, names) => {
    if (!names.length) return '';
    const pills = names.map(n =>
      `<span class="summary-name-pill" style="background:${color}22;color:${color}">${n}</span>`
    ).join('');
    return `
      <div class="summary-section">
        <div class="summary-section-label" style="color:${color}">${emoji} ${label} (${names.length})</div>
        <div class="summary-names">${pills}</div>
      </div>`;
  };

  document.getElementById('app').innerHTML = `
    <div class="hdr">
      <div class="hdr-left">
        <span class="hdr-title">Attendance</span>
        <span class="hdr-date">${DATE}</span>
      </div>
      <div class="hdr-right">
        <span style="font-size:11px;color:var(--vacation)">âœ“ Submitted</span>
      </div>
    </div>

    <div class="summary-card">
      <div class="summary-header">
        <div>
          <div class="summary-header-title">âœ… Attendance Submitted</div>
          <div class="summary-header-sub">Slack notified Â· ${employees.length} employees</div>
        </div>
        <div style="font-size:22px;font-weight:700;color:#5b8dee">${present.length}</div>
      </div>

      ${section('âœ…','Present','#5b8dee', present)}
      ${section('ğŸ•','Late','#e6a817', late)}
      ${section('âŒ','Absent','#e54545', absent)}
      ${section('ğŸ¤’','Sick','#9b59f5', sick)}
      ${section('ğŸŒ´','Vacation','#11c987', vacation)}

      <div class="summary-footer">
        <span class="summary-footer-stat">${DATE}</span>
        <span class="summary-footer-stat">${employees.length - present.length} flagged</span>
      </div>
    </div>`;

  if (t) t.sizeTo('#app').catch(()=>{});
}

// reopenAttendance removed â€” submission is final

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Edit Mode â€” correct LASV counts on hidden board
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function showEditMode() {
  // Load current log cards so we show live counts
  document.getElementById('app').innerHTML = `
    <div class="hdr">
      <div class="hdr-left"><span class="hdr-title">Edit LASV Counts</span></div>
      <div class="hdr-right">
        <button class="btn-sm" onclick="showSummary()">â† Back</button>
      </div>
    </div>
    <div class="state"><div class="spinner"></div>Loading current counts...</div>`;
  if (t) t.sizeTo('#app').catch(()=>{});

  try {
    // Edit directly from 2026 Employee cards
    const rows_data = employees.map(emp => ({
      name: emp.name,
      ctr:  emp.counters,
      cid:  emp.cardId,
    }));

    const rows = rows_data.map(({name, ctr, cid}) => {
      return `
        <div class="edit-row">
          <div class="edit-name">${name}</div>
          <div class="edit-counters">
            <div class="edit-field"><label>ğŸ•</label><input class="edit-input" type="number" min="0" value="${ctr.L}" id="L_${cid}"></div>
            <div class="edit-field"><label>âŒ</label><input class="edit-input" type="number" min="0" value="${ctr.A}" id="A_${cid}"></div>
            <div class="edit-field"><label>ğŸ¤’</label><input class="edit-input" type="number" min="0" value="${ctr.S}" id="S_${cid}"></div>
            <div class="edit-field"><label>ğŸŒ´</label><input class="edit-input" type="number" min="0" value="${ctr.V}" id="V_${cid}"></div>
          </div>
          <button class="btn-save-edit" onclick="saveEdit('${cid}','${name}')" id="savebtn_${cid}">Save</button>
        </div>`;
    }).join('');

    document.getElementById('app').innerHTML = `
      <div class="hdr">
        <div class="hdr-left">
          <span class="hdr-title">Edit LASV Counts</span>
          <span class="hdr-date">${year()}</span>
        </div>
        <div class="hdr-right">
          <button class="btn-sm" onclick="showSummary()">â† Back</button>
        </div>
      </div>
      <div style="padding:6px 12px 4px;font-size:11px;color:var(--sub)">
        Adjust counts per employee. Changes are saved to the hidden board immediately.
      </div>
      <div class="edit-section">
        <div class="edit-header">
          <span>Employee</span>
          <span style="display:flex;gap:20px;font-size:10px">ğŸ• &nbsp;âŒ &nbsp;ğŸ¤’ &nbsp;ğŸŒ´</span>
        </div>
        ${rows}
      </div>`;
    if (t) t.sizeTo('#app').catch(()=>{});

  } catch(e) {
    document.getElementById('app').innerHTML = `
      <div class="state error">âš ï¸ ${e.message}
        <br/><br/><button class="btn-sm" onclick="showSummary()">â† Back</button>
      </div>`;
    if (t) t.sizeTo('#app').catch(()=>{});
  }
}

async function saveEdit(cardId, empName) {
  const btnId = `savebtn_${cardId}`;
  const btn   = document.getElementById(btnId);
  if (btn) { btn.disabled = true; btn.textContent = 'Saving...'; }

  try {
    const L = parseInt(document.getElementById(`L_${cardId}`)?.value) || 0;
    const A = parseInt(document.getElementById(`A_${cardId}`)?.value) || 0;
    const S = parseInt(document.getElementById(`S_${cardId}`)?.value) || 0;
    const V = parseInt(document.getElementById(`V_${cardId}`)?.value) || 0;

    // Write directly to the employee's card in 2026 Employee
    await api(`/cards/${cardId}`,'PUT',{ desc: buildDesc({L,A,S,V}) });

    // Update local counter
    const emp = employees.find(e => e.name === empName);
    if (emp) emp.counters = {L,A,S,V};

    if (btn) { btn.textContent = 'âœ“ Saved'; btn.style.color = 'var(--vacation)'; btn.style.borderColor = 'var(--vacation)'; }
    setTimeout(() => { if (btn) { btn.textContent = 'Save'; btn.disabled = false; btn.style.color=''; btn.style.borderColor=''; } }, 2000);

  } catch(e) {
    if (btn) { btn.textContent = 'âœ— Error'; btn.disabled = false; }
    console.error(e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Log helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// getOrCreateLogList removed â€” logging goes to 2026 Employee cards directly

async function logEmployee(emp, statusKey) {
  const DATE   = today();
  const status = STATUS[statusKey];

  // Use the employee's own card in "2026 Employee" list
  // cardId was stored when we loaded employees
  const cardId = emp.cardId;

  // Get latest desc to avoid overwriting concurrent changes
  const card = await api(`/cards/${cardId}?fields=desc`);
  const counters = parseDesc(card.desc);
  counters[statusKey]++;

  // Update counter table in description
  await api(`/cards/${cardId}`,'PUT',{ desc: buildDesc(counters) });

  // Add comment log entry
  await api(`/cards/${cardId}/actions/comments`,'POST',{
    text: `${emp.name} â€” ${status.label} â€” ${DATE}`,
  });

  // Update local counter so summary screen shows correct numbers
  emp.counters[statusKey] = (emp.counters[statusKey] || 0) + 1;
}

function buildDesc(c) {
  return `## LASV Summary\n\n| Late | Absent | Sick | Vacation |\n|------|--------|------|----------|\n| ${c.L||0} | ${c.A||0} | ${c.S||0} | ${c.V||0} |`;
}

function parseDesc(desc) {
  const d = {L:0,A:0,S:0,V:0};
  if (!desc) return d;
  const m = desc.match(/\|\s*(\d+)\s*\|\s*(\d+)\s*\|\s*(\d+)\s*\|\s*(\d+)\s*\|/);
  if (m) { d.L=+m[1]; d.A=+m[2]; d.S=+m[3]; d.V=+m[4]; }
  return d;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Slack
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendSlack() {
  const DATE    = today();
  const present  = employees.filter(e => selections[e.name]==='P').map(e=>e.name);
  const late     = employees.filter(e => selections[e.name]==='L').map(e=>e.name);
  const absent   = employees.filter(e => selections[e.name]==='A').map(e=>e.name);
  const sick     = employees.filter(e => selections[e.name]==='S').map(e=>e.name);
  const vacation = employees.filter(e => selections[e.name]==='V').map(e=>e.name);

  const section = (emoji, label, names) =>
    names.length ? `${emoji} *${label}* (${names.length})\n${names.map(n=>`â€¢ ${n}`).join('\n')}` : null;

  const text = [
    `ğŸ“‹ *Daily Attendance â€” ${DATE}*`,
    `_${employees.length} employees Â· ${present.length} present today_`,
    '',
    section('âœ…', 'Present',  present),
    section('ğŸ•', 'Late',     late),
    section('âŒ', 'Absent',   absent),
    section('ğŸ¤’', 'Sick',     sick),
    section('ğŸŒ´', 'Vacation', vacation),
  ].filter(l => l !== null).join('\n');

  await fetch(CFG.SLACK_WEBHOOK, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ text }),
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Auth screen
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showAuth() {
  document.getElementById('app').innerHTML = `
    <div class="auth-screen">
      <p><strong>One-time setup</strong> â€” get your Trello token:</p>
      <p>
        <a href="https://trello.com/1/authorize?expiration=never&scope=read,write&response_type=token&key=${CFG.API_KEY}&name=CF+Daily+Attendance" target="_blank">
          â†’ Open Trello Authorization Page
        </a><br/>
        Click <strong>Allow</strong>, then copy and paste the token below:
      </p>
      <textarea class="auth-textarea" id="tokenInput" placeholder="Paste token here (starts with ATTA...)"></textarea>
      <button class="btn-sm primary" style="width:100%;padding:8px" onclick="saveToken()">Save Token</button>
      <div id="authMsg" style="font-size:11px;color:var(--absent);margin-top:6px;min-height:14px;font-family:monospace"></div>
    </div>`;
  if (t) t.sizeTo('#app').catch(()=>{});
}

async function saveToken() {
  const val = document.getElementById('tokenInput')?.value.trim();
  const msg = document.getElementById('authMsg');
  if (!val) { if(msg) msg.textContent='Paste your token first.'; return; }
  if (val.length < 40) { if(msg) msg.textContent='Token too short â€” copy the whole thing.'; return; }
  try {
    await t.set('member','private','token', val);
    token = val;
    await boot();
  } catch(e) {
    if(msg) msg.textContent = 'Error: ' + e.message;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI state helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setState(type, msg) {
  document.getElementById('app').innerHTML = type === 'loading'
    ? `<div class="state"><div class="spinner"></div>${msg}</div>`
    : `<div class="state error">âš ï¸ ${msg}<br/><br/><button class="btn-sm" onclick="boot()">â†º Retry</button></div>`;
  if (t) t.sizeTo('#app').catch(()=>{});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Boot
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function boot() {
  setState('loading', 'Initializing...');
  try {
    if (!t) {
      t = window.TrelloPowerUp.iframe({
        appKey:  CFG.API_KEY,
        appName: 'CF Daily Attendance',
      });
    }

    token = await t.get('member','private','token');
    if (!token) { showAuth(); return; }

    await loadEmployees();
    render();

  } catch(e) {
    console.error(e);
    if (!token) { showAuth(); return; }
    setState('error', e.message);
  }
}

boot();
</script>
</body>
</html>
