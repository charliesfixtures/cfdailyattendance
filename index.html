<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daily Attendance</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Sora:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:      #0d0f14;
      --surface: #161920;
      --card:    #1e2130;
      --border:  #2d3148;
      --accent:  #5b8dee;
      --late:    #f0a500;
      --absent:  #e84545;
      --sick:    #9b59f5;
      --vacation:#11c987;
      --text:    #eef0f6;
      --sub:     #8b91a8;
      --radius:  12px;
    }

    body {
      font-family: 'Sora', sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 14px;
    }

    /* â”€â”€ Header â”€â”€ */
    .header {
      display: flex; align-items: center; gap: 10px;
      margin-bottom: 14px; padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .header-icon {
      width: 32px; height: 32px; background: var(--accent);
      border-radius: 8px; display: flex; align-items: center;
      justify-content: center; font-size: 16px; flex-shrink: 0;
    }
    .header-title { font-size: 14px; font-weight: 700; color: var(--text); }
    .header-date  { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--sub); margin-top: 1px; }
    .header-refresh {
      margin-left: auto; background: transparent; border: 1px solid var(--border);
      color: var(--sub); border-radius: 6px; padding: 4px 10px;
      font-size: 11px; cursor: pointer; font-family: 'DM Mono', monospace; transition: all 0.2s;
    }
    .header-refresh:hover { border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ States â”€â”€ */
    .state-box {
      text-align: center; padding: 40px 16px;
      font-family: 'DM Mono', monospace; font-size: 13px; color: var(--sub); line-height: 1.7;
    }
    .state-box.error { color: var(--absent); }
    .spinner {
      width: 26px; height: 26px; border: 3px solid var(--border);
      border-top-color: var(--accent); border-radius: 50%;
      animation: spin 0.8s linear infinite; margin: 0 auto 14px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Auth box â”€â”€ */
    .auth-box {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 18px; margin-top: 16px;
    }

    /* â”€â”€ Summary pills â”€â”€ */
    .summary-row {
      display: grid; grid-template-columns: repeat(5, 1fr);
      gap: 6px; margin-bottom: 12px;
    }
    .summary-pill {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 8px; padding: 7px 4px;
      display: flex; flex-direction: column; align-items: center; gap: 2px;
    }
    .summary-pill .count { font-size: 18px; font-weight: 700; line-height: 1; }
    .summary-pill .label { font-size: 9px; color: var(--sub); font-family: 'DM Mono', monospace; letter-spacing: 0.3px; }

    /* â”€â”€ Employee list â”€â”€ */
    .employee-list { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }

    .employee-row {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 10px 12px;
      display: flex; flex-direction: column; gap: 8px;
      transition: border-color 0.2s; animation: fadeIn 0.2s ease both;
    }
    .employee-row.status-L { border-color: var(--late);    background: #1e1a0e; }
    .employee-row.status-A { border-color: var(--absent);  background: #1e0e0e; }
    .employee-row.status-S { border-color: var(--sick);    background: #170e1e; }
    .employee-row.status-V { border-color: var(--vacation);background: #0e1e16; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .employee-row:nth-child(1)  { animation-delay:.02s }
    .employee-row:nth-child(2)  { animation-delay:.04s }
    .employee-row:nth-child(3)  { animation-delay:.06s }
    .employee-row:nth-child(4)  { animation-delay:.08s }
    .employee-row:nth-child(5)  { animation-delay:.10s }
    .employee-row:nth-child(6)  { animation-delay:.12s }
    .employee-row:nth-child(7)  { animation-delay:.14s }
    .employee-row:nth-child(8)  { animation-delay:.16s }
    .employee-row:nth-child(9)  { animation-delay:.18s }
    .employee-row:nth-child(10) { animation-delay:.20s }

    /* â”€â”€ Top row: avatar + name + status badge â”€â”€ */
    .emp-top {
      display: flex; align-items: center; gap: 10px;
    }
    .emp-avatar {
      width: 38px; height: 38px; border-radius: 50%;
      background: var(--border); flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 700; font-family: 'DM Mono', monospace;
      overflow: hidden; border: 2px solid var(--border);
    }
    .emp-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .emp-avatar.status-L { border-color: var(--late); }
    .emp-avatar.status-A { border-color: var(--absent); }
    .emp-avatar.status-S { border-color: var(--sick); }
    .emp-avatar.status-V { border-color: var(--vacation); }

    .emp-info { flex: 1; min-width: 0; }
    .emp-name { font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .emp-status-badge {
      font-size: 10px; font-family: 'DM Mono', monospace;
      padding: 2px 7px; border-radius: 20px; font-weight: 600;
      display: none;
    }
    .emp-status-badge.show { display: inline-block; margin-top: 3px; }
    .badge-L { background: var(--late);    color: #000; }
    .badge-A { background: var(--absent);  color: #fff; }
    .badge-S { background: var(--sick);    color: #fff; }
    .badge-V { background: var(--vacation);color: #000; }

    /* â”€â”€ Status buttons row â”€â”€ */
    .status-buttons {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px;
    }
    .status-btn {
      padding: 7px 4px; border-radius: 7px;
      border: 1px solid var(--border); background: var(--surface);
      color: var(--sub); font-size: 11px; font-family: 'DM Mono', monospace;
      font-weight: 500; cursor: pointer; transition: all 0.15s;
      text-align: center; white-space: nowrap;
    }
    .status-btn:hover { border-color: var(--sub); color: var(--text); }
    .status-btn.active-L { background: var(--late);    border-color: var(--late);    color: #000; font-weight: 700; }
    .status-btn.active-A { background: var(--absent);  border-color: var(--absent);  color: #fff; font-weight: 700; }
    .status-btn.active-S { background: var(--sick);    border-color: var(--sick);    color: #fff; font-weight: 700; }
    .status-btn.active-V { background: var(--vacation);border-color: var(--vacation);color: #000; font-weight: 700; }
    .status-btn[data-s="L"]:hover:not([class*="active"]) { background:#2a2000; border-color:var(--late);    color:var(--late);    }
    .status-btn[data-s="A"]:hover:not([class*="active"]) { background:#2a0000; border-color:var(--absent);  color:var(--absent);  }
    .status-btn[data-s="S"]:hover:not([class*="active"]) { background:#1a0a2a; border-color:var(--sick);    color:var(--sick);    }
    .status-btn[data-s="V"]:hover:not([class*="active"]) { background:#002a18; border-color:var(--vacation);color:var(--vacation);}

    /* â”€â”€ Actions â”€â”€ */
    .actions { display: flex; gap: 8px; margin-top: 4px; }
    .btn-submit {
      flex: 1; padding: 12px; background: var(--accent); color: #fff;
      border: none; border-radius: var(--radius);
      font-family: 'Sora', sans-serif; font-size: 13px; font-weight: 700;
      cursor: pointer; transition: opacity 0.2s, transform 0.1s;
    }
    .btn-submit:hover { opacity: 0.88; transform: translateY(-1px); }
    .btn-submit:active { transform: translateY(0); }
    .btn-submit:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }
    .btn-secondary {
      padding: 12px 14px; background: transparent; color: var(--sub);
      border: 1px solid var(--border); border-radius: var(--radius);
      font-family: 'Sora', sans-serif; font-size: 13px; cursor: pointer; transition: all 0.2s;
    }
    .btn-secondary:hover { border-color: var(--sub); color: var(--text); }

    .status-msg {
      text-align: center; font-size: 12px; font-family: 'DM Mono', monospace;
      margin-top: 10px; min-height: 18px; color: var(--vacation);
    }
    .status-msg.error { color: var(--absent); }

    .emp-count {
      font-size: 10px; color: var(--sub); font-family: 'DM Mono', monospace;
      margin-bottom: 8px; text-align: right;
    }
  </style>
</head>
<body>
<div id="app"><div class="state-box"><div class="spinner"></div>Initializing...</div></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
  TRELLO_API_KEY:     '53abc1f4686798eadbeb8f91ea79c9bb',
  LOG_BOARD_ID:       '6965633f4fe5254c47e38527',
  SLACK_WEBHOOK:      'SLACK_WEBHOOK_PLACEHOLDER',  // injected at deploy time â€” never hardcoded
  EMPLOYEE_LIST_NAME: '2026 Employee',  // exact name of the list on your hidden board
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Constants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATUS_MAP = {
  L: { label: 'Late',     full: 'Late',     emoji: 'ğŸ•' },
  A: { label: 'Absent',   full: 'Absent',   emoji: 'âŒ' },
  S: { label: 'Sick',     full: 'Sick',     emoji: 'ğŸ¤’' },
  V: { label: 'Vacation', full: 'Vacation', emoji: 'ğŸŒ´' },
};

function todayFormatted() {
  return new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
function currentYear() { return new Date().getFullYear().toString(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  App State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let t            = null;   // Trello iframe context
let trelloToken  = null;
let employees    = [];     // string[]  â€” loaded from hidden board
let attendance   = {};     // { name: 'L'|'A'|'S'|'V'|null }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Trello API helper
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(path, method = 'GET', body = null) {
  const sep = path.includes('?') ? '&' : '?';
  const url = `https://api.trello.com/1${path}${sep}key=${CONFIG.TRELLO_API_KEY}&token=${trelloToken}`;
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(url, opts);
  if (!res.ok) throw new Error(`Trello ${res.status}: ${await res.text()}`);
  return res.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Load employees from "2026 Employee" list
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadEmployees() {
  setLoading('Fetching employee list from Trello...');
  const lists = await api(`/boards/${CONFIG.LOG_BOARD_ID}/lists`);
  const empList = lists.find(l => l.name.trim().toLowerCase() === CONFIG.EMPLOYEE_LIST_NAME.toLowerCase());

  if (!empList) throw new Error(
    `Could not find a list named "${CONFIG.EMPLOYEE_LIST_NAME}" on your hidden board.\n` +
    `Go to your hidden board â†’ create a list called exactly "${CONFIG.EMPLOYEE_LIST_NAME}" â†’ add one card per employee.`
  );

  const cards = await api(`/lists/${empList.id}/cards?fields=name,cover`);
  if (!cards.length) throw new Error(
    `The "${CONFIG.EMPLOYEE_LIST_NAME}" list has no cards.\n` +
    `Add one card per employee (the card title = the employee name).`
  );

  employees = cards
    .map(c => ({
      name: c.name.trim(),
      photo: c.cover && c.cover.scaled
        ? c.cover.scaled.find(s => s.width >= 70)?.url || c.cover.scaled[0]?.url || null
        : null,
    }))
    .filter(e => e.name)
    .sort((a,b) => a.name.localeCompare(b.name));
  attendance = {};
  employees.forEach(e => attendance[e.name] = null);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setLoading(msg) {
  document.getElementById('app').innerHTML =
    `<div class="state-box"><div class="spinner"></div>${msg}</div>`;
}

function setError(msg) {
  document.getElementById('app').innerHTML =
    `<div class="state-box error">âš ï¸ ${msg.replace(/\n/g, '<br/>')}</div>
     <div style="text-align:center;margin-top:12px">
       <button class="btn-secondary" onclick="init()">â†º Retry</button>
     </div>`;
}

function setAuthScreen() {
  document.getElementById('app').innerHTML = `
    <div class="header">
      <div class="header-icon">ğŸ“‹</div>
      <div><div class="header-title">Daily Attendance</div><div class="header-date">${todayFormatted()}</div></div>
    </div>
    <div class="auth-box">
      <p style="margin-bottom:12px;font-size:12px;line-height:1.7">
        <strong>Step 1:</strong> Click the link below to get your token (opens new tab):<br/>
        <a href="https://trello.com/1/authorize?expiration=never&scope=read,write&response_type=token&key=53abc1f4686798eadbeb8f91ea79c9bb&name=CF+Daily+Attendance" target="_blank" style="color:#4f8ef7">â†’ Get Trello Token</a>
      </p>
      <p style="margin-bottom:8px;font-size:12px"><strong>Step 2:</strong> Copy the token, paste it here:</p>
      <textarea id="tokenPaste" style="width:100%;height:70px;padding:8px;border-radius:8px;border:1px solid #2a2d3e;background:#0f1117;color:#e2e8f0;font-family:monospace;font-size:11px;resize:none;margin-bottom:10px" placeholder="Paste token here (starts with ATTA...)"></textarea>
      <button class="btn-submit" style="width:100%" onclick="saveTokenFromPaste()">ğŸ’¾ Save & Continue</button>
      <div id="authMsg" style="font-size:11px;color:#ef4444;margin-top:8px;min-height:16px;font-family:monospace"></div>
    </div>`;
}

async function saveTokenFromPaste() {
  const token = document.getElementById('tokenPaste').value.trim();
  const msg   = document.getElementById('authMsg');
  if (!token) { msg.textContent = 'Please paste your token first.'; return; }
  if (token.length < 40) { msg.textContent = 'Token looks too short â€” copy the whole thing.'; return; }
  msg.style.color = '#64748b';
  msg.textContent = 'Saving...';
  try {
    await t.set('member', 'private', 'token', token);
    trelloToken = token;
    await init();
  } catch(e) {
    msg.style.color = '#ef4444';
    msg.textContent = 'Error saving: ' + e.message;
  }
}

function render() {
  const TODAY = todayFormatted();
  const counts = { present:0, L:0, A:0, S:0, V:0 };
  employees.forEach(e => { const s = attendance[e.name]; if(s) counts[s]++; else counts.present++; });

  document.getElementById('app').innerHTML = `
    <div class="header">
      <div class="header-icon">ğŸ“‹</div>
      <div><div class="header-title">Daily Attendance</div><div class="header-date">${TODAY}</div></div>
      <button class="header-refresh" onclick="refreshList()" title="Reload employee list">â†º Refresh</button>
    </div>

    <div class="summary-row">
      <div class="summary-pill"><span class="count" style="color:#5b8dee">${counts.present}</span><span class="label">PRESENT</span></div>
      <div class="summary-pill"><span class="count" style="color:#f0a500">${counts.L}</span><span class="label">LATE</span></div>
      <div class="summary-pill"><span class="count" style="color:#e84545">${counts.A}</span><span class="label">ABSENT</span></div>
      <div class="summary-pill"><span class="count" style="color:#9b59f5">${counts.S}</span><span class="label">SICK</span></div>
      <div class="summary-pill"><span class="count" style="color:#11c987">${counts.V}</span><span class="label">VACATION</span></div>
    </div>

    <div class="emp-count">${employees.length} employees loaded</div>

    <div class="employee-list">
      ${employees.map((emp, i) => {
        const s   = attendance[emp.name];
        const initials = emp.name.split(' ').map(w => w[0]).join('').slice(0,2).toUpperCase();
        const firstName = emp.name.split(' ')[0];
        const avatarContent = emp.photo
          ? `<img src="${emp.photo}" alt="${firstName}" onerror="this.style.display='none';this.parentNode.textContent='${initials}'">`
          : initials;
        const badgeClass = s ? `emp-status-badge show badge-${s}` : 'emp-status-badge';
        const badgeText  = s ? STATUS_MAP[s].full : '';
        return `
        <div class="employee-row${s ? ' status-'+s : ''}" style="animation-delay:${(i+1)*0.03}s">
          <div class="emp-top">
            <div class="emp-avatar${s ? ' status-'+s : ''}">${avatarContent}</div>
            <div class="emp-info">
              <div class="emp-name">${emp.name}</div>
              <span class="${badgeClass}">${badgeText}</span>
            </div>
          </div>
          <div class="status-buttons">
            ${Object.entries(STATUS_MAP).map(([k,v]) =>
              `<button class="status-btn${s===k ? ' active-'+k : ''}" data-s="${k}"
                onclick="toggle(${JSON.stringify(emp.name)},${JSON.stringify(k)})">${v.emoji} ${v.full}</button>`
            ).join('')}
          </div>
        </div>`;
      }).join('')}
    </div>

    <div class="actions">
      <button class="btn-secondary" onclick="resetAll()">Reset</button>
      <button class="btn-submit" onclick="submit()" id="submitBtn">âœ“ Submit Attendance</button>
    </div>
    <div class="status-msg" id="statusMsg"></div>
  `;

  if (t) t.sizeTo('#app').catch(()=>{});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Interactions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggle(name, status) {
  attendance[name] = attendance[name] === status ? null : status;
  render();
}
function resetAll() { employees.forEach(e => attendance[e.name] = null); render(); }
async function refreshList() {
  try { await loadEmployees(); render(); } catch(e) { setError(e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Submit
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submit() {
  const btn = document.getElementById('submitBtn');
  const msg = document.getElementById('statusMsg');
  btn.disabled = true; msg.textContent = ''; msg.className = 'status-msg';

  try {
    const logListId = await getOrCreateLogList();
    const flagged   = employees.filter(e => attendance[e.name]).map(e => e.name);

    for (const name of flagged) {
      btn.textContent = `Logging ${name}...`;
      await logEmployee(logListId, name, attendance[name]);
    }

    btn.textContent = 'Notifying Slack...';
    await sendSlack();

    msg.textContent = `âœ“ Done! ${flagged.length} employee(s) logged. Slack notified.`;
  } catch(e) {
    console.error(e);
    msg.textContent = 'âœ— ' + e.message;
    msg.className = 'status-msg error';
  } finally {
    btn.disabled = false;
    btn.textContent = 'âœ“ Submit Attendance';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Trello log helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function getOrCreateLogList() {
  const YEAR  = currentYear();
  const lists = await api(`/boards/${CONFIG.LOG_BOARD_ID}/lists`);
  let list = lists.find(l => l.name === YEAR);
  if (!list) list = await api('/lists', 'POST', { name: YEAR, idBoard: CONFIG.LOG_BOARD_ID });
  return list.id;
}

async function logEmployee(logListId, name, statusKey) {
  const TODAY = todayFormatted();
  const cards = await api(`/lists/${logListId}/cards`);
  let card = cards.find(c => c.name.toLowerCase() === name.toLowerCase());

  if (!card) {
    card = await api('/cards', 'POST', {
      name,
      idList: logListId,
      desc: buildDesc({ L:0, A:0, S:0, V:0 }),
    });
  }

  const counters = parseDesc(card.desc);
  counters[statusKey] = (counters[statusKey] || 0) + 1;
  await api(`/cards/${card.id}`, 'PUT', { desc: buildDesc(counters) });
  await api(`/cards/${card.id}/actions/comments`, 'POST', {
    text: `${TODAY} â€” ${STATUS_MAP[statusKey].full}`,
  });
}

function buildDesc(c) {
  return `## LASV Summary\n\n| Late | Absent | Sick | Vacation |\n|------|--------|------|----------|\n| ${c.L||0} | ${c.A||0} | ${c.S||0} | ${c.V||0} |`;
}

function parseDesc(desc) {
  const d = { L:0, A:0, S:0, V:0 };
  if (!desc) return d;
  const m = desc.match(/\|\s*(\d+)\s*\|\s*(\d+)\s*\|\s*(\d+)\s*\|\s*(\d+)\s*\|/);
  if (m) { d.L=+m[1]; d.A=+m[2]; d.S=+m[3]; d.V=+m[4]; }
  return d;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Slack
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendSlack() {
  const TODAY = todayFormatted();
  const present  = employees.filter(e => !attendance[e.name]).map(e => e.name);
  const late     = employees.filter(e => attendance[e.name]==='L').map(e => e.name);
  const absent   = employees.filter(e => attendance[e.name]==='A').map(e => e.name);
  const sick     = employees.filter(e => attendance[e.name]==='S').map(e => e.name);
  const vacation = employees.filter(e => attendance[e.name]==='V').map(e => e.name);
  const line = (e,l,arr) => arr.length ? `${e} *${l}* (${arr.length}): ${arr.join(', ')}` : null;

  const text = [
    `ğŸ“‹ *Daily Attendance â€” ${TODAY}*`, '',
    line('âœ…','Present',present), line('ğŸ•','Late',late),
    line('âŒ','Absent',absent),   line('ğŸ¤’','Sick',sick),
    line('ğŸŒ´','Vacation',vacation),
  ].filter(l => l!==null).join('\n');

  await fetch(CONFIG.SLACK_WEBHOOK, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text }),
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Authorization (one-time popup)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doAuthorize() {
  const authUrl =
    `https://trello.com/1/authorize?expiration=never&scope=read,write` +
    `&response_type=token&key=${CONFIG.TRELLO_API_KEY}&name=Daily+Attendance`;

  const popup = window.open(authUrl, 'trello-auth', 'width=500,height=600,left=200,top=100');

  window.addEventListener('message', async function handler(e) {
    if (typeof e.data === 'string' && e.data.length === 64) {
      window.removeEventListener('message', handler);
      trelloToken = e.data;
      try { await t.set('member', 'private', 'token', trelloToken); } catch(_) {}
      if (popup && !popup.closed) popup.close();
      await init();
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Boot
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  setLoading('Initializing...');
  try {
    t = window.TrelloPowerUp.iframe({
      appKey:  CONFIG.TRELLO_API_KEY,
      appName: 'Daily Attendance',
    });

    trelloToken = await t.get('member', 'private', 'token');

    // Fallback: check localStorage (stored by setup.html)
    if (!trelloToken) {
      const lsToken = localStorage.getItem('trello_attendance_token');
      if (lsToken) {
        await t.set('member', 'private', 'token', lsToken);
        localStorage.removeItem('trello_attendance_token');
        trelloToken = lsToken;
      }
    }

    if (!trelloToken) {
      setAuthScreen();
      return;
    }

    await loadEmployees();
    render();

  } catch(e) {
    console.error('Boot error:', e);
    if (!trelloToken) {
      setAuthScreen();
    } else {
      setError(e.message);
    }
  }
}

init();
</script>
</body>
</html>
